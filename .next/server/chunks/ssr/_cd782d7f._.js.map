{"version":3,"sources":["../../../../src/lib/actions/blog.ts","../../../../.next-internal/server/app/%28dashboard%29/website/blog/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\r\n\r\nimport { createClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport { generateSlug } from \"@/lib/blog-utils\";\r\n\r\nexport interface BlogPost {\r\n    id: string;\r\n    slug: string;\r\n    title: string;\r\n    excerpt: string;\r\n    content: string;\r\n    featured_image?: string;\r\n    image_caption?: string;\r\n    category_id?: string;\r\n    category?: string; // Legacy field\r\n    tags?: string[];\r\n    is_published: boolean;\r\n    published_at?: string;\r\n    created_by: string;\r\n    updated_by?: string;\r\n    created_at: string;\r\n    updated_at: string;\r\n    // Joined data\r\n    blog_categories?: {\r\n        id: string;\r\n        name: string;\r\n        slug: string;\r\n        color: string;\r\n    };\r\n}\r\n\r\nexport interface BlogPostWithCategory extends BlogPost {\r\n    category_name?: string;\r\n    category_slug?: string;\r\n    category_color?: string;\r\n}\r\n\r\nexport async function getBlogPosts(filters?: {\r\n    published?: boolean;\r\n    categoryId?: string;\r\n    search?: string;\r\n    limit?: number;\r\n    offset?: number;\r\n}) {\r\n    const supabase = createClient();\r\n\r\n    let query = supabase\r\n        .from(\"blog_posts\")\r\n        .select(`\r\n      *,\r\n      blog_categories (\r\n        id,\r\n        name,\r\n        slug,\r\n        color\r\n      )\r\n    `)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n    if (filters?.published !== undefined) {\r\n        query = query.eq(\"is_published\", filters.published);\r\n    }\r\n\r\n    if (filters?.categoryId) {\r\n        query = query.eq(\"category_id\", filters.categoryId);\r\n    }\r\n\r\n    if (filters?.search) {\r\n        query = query.or(`title.ilike.%${filters.search}%,excerpt.ilike.%${filters.search}%`);\r\n    }\r\n\r\n    if (filters?.limit) {\r\n        query = query.limit(filters.limit);\r\n    }\r\n\r\n    if (filters?.offset) {\r\n        query = query.range(filters.offset, filters.offset + (filters.limit || 10) - 1);\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching blog posts:\", error);\r\n        return [];\r\n    }\r\n\r\n    return data as BlogPost[];\r\n}\r\n\r\nexport async function getBlogPost(slug: string) {\r\n    const supabase = createClient();\r\n\r\n    const { data, error } = await supabase\r\n        .from(\"blog_posts\")\r\n        .select(`\r\n      *,\r\n      blog_categories (\r\n        id,\r\n        name,\r\n        slug,\r\n        color\r\n      )\r\n    `)\r\n        .eq(\"slug\", slug)\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching blog post:\", error);\r\n        return null;\r\n    }\r\n\r\n    return data as BlogPost;\r\n}\r\n\r\nexport async function getBlogPostById(id: string) {\r\n    const supabase = createClient();\r\n\r\n    const { data, error } = await supabase\r\n        .from(\"blog_posts\")\r\n        .select(`\r\n      *,\r\n      blog_categories (\r\n        id,\r\n        name,\r\n        slug,\r\n        color\r\n      )\r\n    `)\r\n        .eq(\"id\", id)\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching blog post:\", error);\r\n        return null;\r\n    }\r\n\r\n    return data as BlogPost;\r\n}\r\n\r\nexport async function createBlogPost(formData: FormData) {\r\n    const supabase = createClient();\r\n\r\n    // Get current user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) throw new Error(\"Not authenticated\");\r\n\r\n    const title = formData.get(\"title\") as string;\r\n    const slug = formData.get(\"slug\") as string;\r\n    const excerpt = formData.get(\"excerpt\") as string;\r\n    const content = formData.get(\"content\") as string;\r\n    const featured_image = formData.get(\"featured_image\") as string;\r\n    const image_caption = formData.get(\"image_caption\") as string;\r\n    const category_id = formData.get(\"category_id\") as string;\r\n    const tags = formData.get(\"tags\") as string;\r\n    const is_published = formData.get(\"is_published\") === \"true\";\r\n\r\n    const { data, error } = await supabase\r\n        .from(\"blog_posts\")\r\n        .insert({\r\n            title,\r\n            slug,\r\n            excerpt,\r\n            content,\r\n            featured_image,\r\n            image_caption,\r\n            category_id: category_id || null,\r\n            tags: tags ? tags.split(\",\").map(t => t.trim()) : [],\r\n            is_published,\r\n            published_at: is_published ? new Date().toISOString() : null,\r\n            created_by: user.id,\r\n            updated_by: user.id,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Error creating blog post:\", error);\r\n        throw new Error(error.message);\r\n    }\r\n\r\n    revalidatePath(\"/dashboard/website/blog\");\r\n    revalidatePath(\"/berita\");\r\n    return data;\r\n}\r\n\r\nexport async function updateBlogPost(id: string, formData: FormData) {\r\n    const supabase = createClient();\r\n\r\n    // Get current user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) throw new Error(\"Not authenticated\");\r\n\r\n    const title = formData.get(\"title\") as string;\r\n    const slug = formData.get(\"slug\") as string;\r\n    const excerpt = formData.get(\"excerpt\") as string;\r\n    const content = formData.get(\"content\") as string;\r\n    const featured_image = formData.get(\"featured_image\") as string;\r\n    const image_caption = formData.get(\"image_caption\") as string;\r\n    const category_id = formData.get(\"category_id\") as string;\r\n    const tags = formData.get(\"tags\") as string;\r\n    const is_published = formData.get(\"is_published\") === \"true\";\r\n\r\n    // Get existing post to check if it was previously unpublished\r\n    const existing = await getBlogPostById(id);\r\n    const wasUnpublished = existing && !existing.is_published;\r\n\r\n    const { data, error } = await supabase\r\n        .from(\"blog_posts\")\r\n        .update({\r\n            title,\r\n            slug,\r\n            excerpt,\r\n            content,\r\n            featured_image,\r\n            image_caption,\r\n            category_id: category_id || null,\r\n            tags: tags ? tags.split(\",\").map(t => t.trim()) : [],\r\n            is_published,\r\n            // Only set published_at if newly publishing\r\n            published_at: (is_published && wasUnpublished) ? new Date().toISOString() : existing?.published_at,\r\n            updated_by: user.id,\r\n            updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", id)\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error(\"Error updating blog post:\", error);\r\n        throw new Error(error.message);\r\n    }\r\n\r\n    revalidatePath(\"/dashboard/website/blog\");\r\n    revalidatePath(\"/berita\");\r\n    revalidatePath(`/berita/${slug}`);\r\n    return data;\r\n}\r\n\r\nexport async function deleteBlogPost(id: string) {\r\n    const supabase = createClient();\r\n\r\n    const { error } = await supabase\r\n        .from(\"blog_posts\")\r\n        .delete()\r\n        .eq(\"id\", id);\r\n\r\n    if (error) {\r\n        console.error(\"Error deleting blog post:\", error);\r\n        throw new Error(error.message);\r\n    }\r\n\r\n    revalidatePath(\"/dashboard/website/blog\");\r\n    revalidatePath(\"/berita\");\r\n}\r\n\r\nexport async function togglePublishStatus(id: string, isPublished: boolean) {\r\n    const supabase = createClient();\r\n\r\n    // Get current user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) throw new Error(\"Not authenticated\");\r\n\r\n    const updateData: any = {\r\n        is_published: isPublished,\r\n        updated_by: user.id,\r\n        updated_at: new Date().toISOString(),\r\n    };\r\n\r\n    // Set published_at when publishing for the first time\r\n    if (isPublished) {\r\n        const existing = await getBlogPostById(id);\r\n        if (existing && !existing.published_at) {\r\n            updateData.published_at = new Date().toISOString();\r\n        }\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from(\"blog_posts\")\r\n        .update(updateData)\r\n        .eq(\"id\", id);\r\n\r\n    if (error) {\r\n        console.error(\"Error toggling publish status:\", error);\r\n        throw new Error(error.message);\r\n    }\r\n\r\n    revalidatePath(\"/dashboard/website/blog\");\r\n    revalidatePath(\"/berita\");\r\n}\r\n","export {deleteBlogPost as '40f87eda7a8a5c6ee9a26184faf2000f03182fc17f'} from 'ACTIONS_MODULE0'\nexport {togglePublishStatus as '60640128274db0c02ba5aaab1baaf900c50e9eb0e5'} from 'ACTIONS_MODULE0'\nexport {getBlogPost as '40063d1779801464c4c64accdff167aff5b2253b7d'} from 'ACTIONS_MODULE0'\nexport {getBlogPostById as '401873d7a3baf0ce4da93a44cb6fb62e0e516a8c7d'} from 'ACTIONS_MODULE0'\nexport {getBlogPosts as '40cbf0bbe7b53e6dd4bfe209d9e4ce70c6b811ddc9'} from 'ACTIONS_MODULE0'\nexport {createBlogPost as '40ef95bca06b01a857a28c0b420df332dce5c7712f'} from 'ACTIONS_MODULE0'\nexport {deleteBlogPost as '40f87eda7a8a5c6ee9a26184faf2000f03182fc17f'} from 'ACTIONS_MODULE0'\nexport {updateBlogPost as '60142dd1a0156de72ad66757fac963397e6e8929b6'} from 'ACTIONS_MODULE0'\nexport {togglePublishStatus as '60640128274db0c02ba5aaab1baaf900c50e9eb0e5'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}